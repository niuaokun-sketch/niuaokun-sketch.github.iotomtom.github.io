<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ECO-MONITOR | Â±ÇÊ¨°Â¢ûÂº∫Áâà</title>
    <style>
        /* --- 1. Âü∫Á°ÄÊ†∑Âºè --- */
        body { 
            margin: 0; overflow: hidden; 
            background-color: #ffffff; 
            cursor: none; /* ÈöêËóèÁ≥ªÁªüÈº†Ê†á */ 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        /* --- 2. ËµÑÊñôÈù¢Êùø --- */
        #data-panel {
            position: absolute; right: 40px; top: 50%; transform: translateY(-50%);
            width: 280px; padding: 30px;
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-left: 5px solid #333;
            color: #333;
            display: none; 
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            z-index: 10;
        }
        h2 { margin: 0 0 15px 0; font-size: 24px; letter-spacing: -1px; }
        .tag { 
            display: inline-block; background: #eee; 
            padding: 4px 8px; font-size: 10px; border-radius: 4px; 
            margin-bottom: 20px; font-weight: bold; color: #666;
        }
        .stat-item { margin-bottom: 10px; font-size: 12px; }
        .bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 4px;}
        .bar-fill { height: 100%; background: #333; width: 0%; border-radius: 3px; }

        /* --- 3. È°∂ÈÉ® UI --- */
        #ui-header {
            position: absolute; top: 30px; left: 40px; color: #333;
            pointer-events: none; z-index: 10;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 700; letter-spacing: 1px; }
        p { margin: 5px 0 0 0; font-size: 12px; color: #999; }
    </style>
</head>
<body>

    <!-- UI -->
    <div id="ui-header">
        <h1>ECO-MONITOR</h1>
        <p>Live Bio-Data // Sector 7</p>
    </div>

    <!-- ËµÑÊñôÈù¢Êùø -->
    <div id="data-panel">
        <span class="tag" id="panel-id">ID: 001</span>
        <h2 id="panel-name">Target Name</h2>
        <div class="stat-item">TOXICITY<div class="bar-bg"><div class="bar-fill" id="bar-tox" style="background: #ff4444;"></div></div></div>
        <div class="stat-item">ADAPTATION<div class="bar-bg"><div class="bar-fill" id="bar-adp" style="background: #44cc88;"></div></div></div>
        <p style="font-size:12px; line-height:1.6; color:#666; margin-top:20px;" id="panel-desc">...</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <!-- Shader: ‰øùÊåÅÂæÆÂ∞èÈÅøËÆ© -->
    <script type="x-shader/x-vertex" id="vertexShader">
        uniform float uTime;
        uniform vec3 uMouse;
        attribute float size;
        attribute vec3 customColor;
        varying vec3 vColor;
        void main() {
            vColor = customColor;
            vec3 pos = position;
            // Èº†Ê†áÈÅøËÆ©ÈÄªËæë
            float dist = distance(pos.xz, uMouse.xz);
            float radius = 7.0; 
            if (dist < radius) {
                vec3 dir = normalize(pos - uMouse);
                float force = (radius - dist) / radius;
                pos.x += dir.x * force * 3.0; 
                pos.z += dir.z * force * 3.0;
            }
            vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
            gl_PointSize = size * (200.0 / -mvPosition.z); 
            gl_Position = projectionMatrix * mvPosition;
        }
    </script>

    <script type="x-shader/x-fragment" id="fragmentShader">
        varying vec3 vColor;
        void main() {
            float dist = length(gl_PointCoord - vec2(0.5));
            float alpha = 1.0 - smoothstep(0.4, 0.5, dist);
            if (alpha < 0.01) discard;
            gl_FragColor = vec4(vColor, alpha); 
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. Âú∫ÊôØ ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);
        scene.fog = new THREE.FogExp2(0xffffff, 0.012);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 50, 70);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);

        // --- 2. 3D ÂÖâÊ†áÁ≥ªÁªü (Mesh Cursor) ---
        const cursorGroup = new THREE.Group();
        scene.add(cursorGroup);

        // A. ÂÖ≠ËæπÂΩ¢ÁéØ (Âä†Á≤ó)
        const hexGeometry = new THREE.RingGeometry(2.8, 3.8, 6); 
        const hexMaterial = new THREE.MeshBasicMaterial({ color: 0x333333, side: THREE.DoubleSide });
        const cursorHex = new THREE.Mesh(hexGeometry, hexMaterial);
        cursorHex.rotation.x = -Math.PI / 2;
        cursorGroup.add(cursorHex);

        // B. ÂÄí‰∏âËßíÂΩ¢ÊåáÈíà
        const triGeometry = new THREE.ConeGeometry(0.6, 1.8, 3);
        const triMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
        const cursorTri = new THREE.Mesh(triGeometry, triMaterial);
        cursorTri.rotation.x = Math.PI; 
        cursorTri.position.y = 5; 
        cursorGroup.add(cursorTri);

        // --- 3. Â∞ÑÁ∫ø‰∫§‰∫íÂπ≥Èù¢ ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const hitPlane = new THREE.Mesh(
            new THREE.PlaneGeometry(500, 500),
            new THREE.MeshBasicMaterial({ visible: false })
        );
        hitPlane.rotation.x = -Math.PI / 2;
        scene.add(hitPlane);

        // --- 4. Âú∞ÂΩ¢Á≥ªÁªü (Â¢ûÂä†Â±ÇÊ¨°ÊÑü) ---
        const geometry = new THREE.BufferGeometry();
        const positions = [];
        const colors = [];
        const sizes = [];

        // ÈÖçËâ≤ÊñπÊ°à
        const colWater = new THREE.Color("#99DDFF"); 
        const colLand1 = new THREE.Color("#88CC44"); 
        const colLand2 = new THREE.Color("#66AA33"); 
        const colLand3 = new THREE.Color("#DDEEAA"); 
        // Êñ∞Â¢ûÔºöÊ†ëÂÜ†/Ê∑±Ëâ≤Ê§çË¢´ (Â¢ûÂä†Â±ÇÊ¨°)
        const colCanopy = new THREE.Color("#3A6B29"); // Ê∑±Â¢®Áªø

        const range = 180; const gap = 2.5; 

        function getElevation(x, z) {
            return Math.sin(x * 0.05) * 8 + Math.cos(z * 0.05) * 8;
        }

        for (let x = -range; x < range; x += gap) {
            for (let z = -range; z < range; z += gap) {
                const distToCenter = Math.sqrt(x*x + z*z);
                const maxRadius = 120 + Math.sin(Math.atan2(z, x) * 5.0) * 15.0 + Math.cos(x * 0.1) * 10.0;
                if (distToCenter > maxRadius) continue;

                let y = getElevation(x, z);
                
                let pSize = 0.0; let pColor = new THREE.Color(); let keepPoint = false;
                
                if (y < -3) {
                    // Ê≤≥ÊµÅ
                    if (Math.random() > 0.4) { pSize = 4.0; pColor = colWater; keepPoint = true; }
                } else {
                    // Ê§çË¢´Â±Ç
                    if (Math.random() > 0.5) { 
                        keepPoint = true;
                        const r = Math.random();
                        
                        // üåü Â¢ûÂä†Â±ÇÊ¨°ÊÑüÈÄªËæë üåü
                        if (r > 0.96) { 
                            // Ê†ëÂÜ†Â±Ç (Canopy)ÔºöÊõ¥Â§ßÔºåÈ¢úËâ≤Êõ¥Ê∑±Ôºå‰ΩçÁΩÆÊõ¥È´ò
                            pSize = 7.0; // Â∑®Â§ß
                            pColor = colCanopy;
                            y += 3.0; // ÊÇ¨ÊµÆÂú®Âú∞Èù¢‰∏äÊñπÔºåÂà∂ÈÄ†ËßÜÂ∑ÆÈÅÆÊå°ÊïàÊûú
                        } 
                        else if (r > 0.6) { pSize = 2.5; pColor = colLand2; }
                        else { pSize = 1.5; pColor = colLand3; }
                    }
                }

                if (keepPoint) {
                    positions.push(x, y, z);
                    colors.push(pColor.r, pColor.g, pColor.b);
                    sizes.push(pSize);
                }
            }
        }
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        geometry.setAttribute('customColor', new THREE.Float32BufferAttribute(colors, 3));
        geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

        const shaderMaterial = new THREE.ShaderMaterial({
            uniforms: { uMouse: { value: new THREE.Vector3(0, 0, 0) } },
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('fragmentShader').textContent,
            transparent: true,
            // ÂºÄÂêØÊ∑±Â∫¶ÊµãËØïÔºåÁ°Æ‰øùÂ§ßÁöÑÁÇπËÉΩÊ≠£Á°ÆÈÅÆÊå°Â∞èÁöÑÁÇπ
            depthTest: true, 
            depthWrite: false
        });
        const terrain = new THREE.Points(geometry, shaderMaterial);
        scene.add(terrain);

        // --- 5. Âä®Áâ© ---
        class TriangleAnimal {
            constructor(name, type, color, startPos) {
                this.name = name;
                this.info = { type: type, desc: "Genetic anomaly detected. High priority target." };
                const geo = new THREE.ConeGeometry(2, 4, 3);
                const mat = new THREE.MeshBasicMaterial({ color: color, wireframe: true });
                this.mesh = new THREE.Mesh(geo, mat);
                this.mesh.rotation.x = Math.PI;
                this.mesh.position.copy(startPos);
                this.target = startPos.clone();
                this.speed = 0.08;
                scene.add(this.mesh);
                this.pickTarget();
            }
            pickTarget() {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 80;
                this.target.x = Math.cos(angle) * radius;
                this.target.z = Math.sin(angle) * radius;
            }
            update() {
                const dir = new THREE.Vector3().subVectors(this.target, this.mesh.position);
                if (dir.length() < 1) this.pickTarget();
                dir.normalize();
                this.mesh.position.add(dir.multiplyScalar(this.speed));
                this.mesh.rotation.y += 0.02;
                const y = getElevation(this.mesh.position.x, this.mesh.position.z);
                this.mesh.position.y = y + 8;
            }
        }

        const animals = [
            new TriangleAnimal("TURTLE-X", "Polymer Turtle", 0xff6b6b, new THREE.Vector3(0, 10, 0)),
            new TriangleAnimal("CRAB-9", "Plastic Crab", 0xffaa00, new THREE.Vector3(30, 10, 20)),
            new TriangleAnimal("BIRD-OIL", "Oil Cormorant", 0x4444ff, new THREE.Vector3(-30, 10, -30)),
        ];

        // --- 6. ‰∫§‰∫íÈÄªËæë (Ë∑üÈöèÈº†Ê†á + ÂàíËøáÂèòÂ§ß) ---
        let hoveredTarget = null;
        const mouseWorld = new THREE.Vector3(); 
        
        document.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(hitPlane);
            if (intersects.length > 0) {
                // ÂßãÁªàË∑üÈöèÈº†Ê†áÂ∞ÑÁ∫øÔºå‰∏çË¢´Âê∏Ëµ∞
                mouseWorld.copy(intersects[0].point);
                shaderMaterial.uniforms.uMouse.value.copy(intersects[0].point);
            }
        });

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;
        controls.maxPolarAngle = Math.PI / 2 - 0.1; // ÈôêÂà∂ËßÜËßí
        controls.minPolarAngle = 0;

        controls.addEventListener('start', () => { controls.autoRotate = false; });

        // --- 7. Âä®ÁîªÂæ™ÁéØ ---
        const panel = document.getElementById('data-panel');

        function animate() {
            requestAnimationFrame(animate);
            
            let currentHover = null;

            // 1. Âä®Áâ©Êõ¥Êñ∞ & Ë∑ùÁ¶ªÊ£ÄÊµã
            animals.forEach(anim => {
                anim.update();
                
                // ËÆ°ÁÆóÈº†Ê†á‰∏éÂä®Áâ©ÁöÑÊ∞¥Âπ≥Ë∑ùÁ¶ª
                const dist = new THREE.Vector2(anim.mesh.position.x, anim.mesh.position.z)
                    .distanceTo(new THREE.Vector2(mouseWorld.x, mouseWorld.z));

                if (dist < 8) { 
                    currentHover = anim; 
                } 
            });

            // 2. ÂÖâÊ†áË∑üÈöèÈÄªËæë (ÂßãÁªàË∑üÈöèÈº†Ê†á)
            // ËÆ°ÁÆóÂÖâÊ†áÁöÑÁõÆÊ†á‰ΩçÁΩÆ (Âü∫‰∫éÈº†Ê†á XZ + Âú∞ÂΩ¢È´òÂ∫¶ Y)
            const terrainY = getElevation(mouseWorld.x, mouseWorld.z);
            
            // Âπ≥ÊªëË∑üÈöè
            cursorGroup.position.x += (mouseWorld.x - cursorGroup.position.x) * 0.2;
            cursorGroup.position.z += (mouseWorld.z - cursorGroup.position.z) * 0.2;
            cursorGroup.position.y += (terrainY - cursorGroup.position.y) * 0.2;

            // 3. Áä∂ÊÄÅÂèçÈ¶à (ÂàíËøáÊó∂ÂèòÂ§ß)
            if (currentHover) {
                // Â¶ÇÊûúÂàíËøá‰∫ÜÂä®Áâ©
                if (hoveredTarget !== currentHover) {
                    hoveredTarget = currentHover;
                    // ÊòæÁ§∫‰ø°ÊÅØ
                    document.getElementById('panel-name').innerText = currentHover.name;
                    document.getElementById('panel-desc').innerText = currentHover.info.desc;
                    document.getElementById('bar-tox').style.width = "85%";
                    document.getElementById('bar-adp').style.width = "72%";
                    panel.style.display = 'block';
                }

                // ÂèòÂ§ßÂä®Áîª (Scale up)
                cursorGroup.scale.lerp(new THREE.Vector3(2.5, 2.5, 2.5), 0.1);
                hexMaterial.color.set(0xff4444); // Á∫¢Ëâ≤
                
            } else {
                // Á¶ªÂºÄÂä®Áâ©
                if (hoveredTarget !== null) {
                    hoveredTarget = null;
                    panel.style.display = 'none';
                }

                // ÊÅ¢Â§çÂéüÁä∂
                cursorGroup.scale.lerp(new THREE.Vector3(1, 1, 1), 0.1);
                hexMaterial.color.set(0x333333); // Ê∑±ÁÅ∞
            }

            cursorHex.rotation.z += 0.01;

            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
