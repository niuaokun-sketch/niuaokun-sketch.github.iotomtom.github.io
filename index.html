<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ECO-MONITOR | Bear 71 å¤åˆ»ç‰ˆ</title>
    <style>
        /* --- 1. åŸºç¡€æ ·å¼ --- */
        body { 
            margin: 0; overflow: hidden; 
            background-color: #ffffff; /* çº¯ç™½åº•è‰² */
            cursor: none; 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }

        /* --- 2. UI é¢æ¿ --- */
        #data-panel {
            position: absolute; right: 40px; top: 50%; transform: translateY(-50%);
            width: 280px; padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #ddd;
            border-top: 4px solid #ccaa00; /* åœŸé»„è‰²ç‚¹ç¼€ */
            color: #333;
            display: none; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            z-index: 10;
        }
        h2 { margin: 0 0 10px 0; font-size: 20px; letter-spacing: 1px; font-weight: bold; color: #443300; }
        .tag { 
            display: inline-block; background: #333; color: #fff;
            padding: 3px 6px; font-size: 10px; margin-bottom: 15px; 
            font-family: monospace;
        }
        .stat-item { margin-bottom: 8px; font-size: 11px; font-weight: bold; color: #666; letter-spacing: 1px; }
        .bar-bg { width: 100%; height: 4px; background: #eee; margin-top: 4px;}
        .bar-fill { height: 100%; background: #333; width: 0%; }

        /* --- 3. é¡¶éƒ¨ UI --- */
        #ui-header {
            position: absolute; top: 30px; left: 40px; color: #333;
            pointer-events: none; z-index: 10;
        }
        h1 { margin: 0; font-size: 24px; font-weight: 900; letter-spacing: -1px; }
        p { margin: 5px 0 0 0; font-size: 11px; color: #888; letter-spacing: 2px; }

        /* --- 4. åŠ¨ç‰©æ ‡ç­¾ (å‚è€ƒå›¾é‡Œçš„æ£•è‰²ç‰Œå­) --- */
        .bear71-label {
            position: absolute;
            background: #8B4513; /* æ£•è‰² */
            color: white;
            padding: 4px 10px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            transform: translate(-50%, -150%);
            white-space: nowrap;
        }
        .bear71-label::after {
            content: ''; position: absolute; bottom: -6px; left: 50%;
            transform: translateX(-50%);
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 6px solid #8B4513;
        }
    </style>
</head>
<body>

    <!-- UI -->
    <div id="ui-header">
        <h1>BEAR 71</h1>
        <p>INTERACTIVE DOCUMENTARY // LIVE FEED</p>
    </div>

    <!-- èµ„æ–™é¢æ¿ -->
    <div id="data-panel">
        <span class="tag" id="panel-id">ID: 001</span>
        <h2 id="panel-name">TARGET</h2>
        <div class="stat-item">HR <div class="bar-bg"><div class="bar-fill" id="bar-tox" style="background: #cc3333;"></div></div></div>
        <div class="stat-item">MOV <div class="bar-bg"><div class="bar-fill" id="bar-adp" style="background: #33aa66;"></div></div></div>
        <p style="font-size:11px; line-height:1.5; color:#888; margin-top:15px;" id="panel-desc">...</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <!-- Shader: æ‰å¹³åœ†ç‚¹ + é¼ æ ‡å¾®å°é¿è®© -->
    <script type="x-shader/x-vertex" id="vertexShader">
        uniform vec3 uMouse;
        attribute float size;
        attribute vec3 customColor;
        varying vec3 vColor;
        void main() {
            vColor = customColor;
            vec3 pos = position;
            
            // é¼ æ ‡äº¤äº’
            float dist = distance(pos.xz, uMouse.xz);
            float radius = 10.0; 
            if (dist < radius) {
                vec3 dir = normalize(pos - uMouse);
                float force = (radius - dist) / radius;
                pos.x += dir.x * force * 4.0; 
                pos.z += dir.z * force * 4.0;
            }
            
            vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
            // è°ƒæ•´å¤§å°ç¼©æ”¾å› å­ï¼Œè®©è¿œå¤„çš„ç‚¹ä¸è‡³äºå¤ªå°
            gl_PointSize = size * (300.0 / -mvPosition.z); 
            gl_Position = projectionMatrix * mvPosition;
        }
    </script>

    <script type="x-shader/x-fragment" id="fragmentShader">
        varying vec3 vColor;
        void main() {
            // ç»˜åˆ¶å®Œç¾çš„æ‰å¹³åœ†
            float dist = length(gl_PointCoord - vec2(0.5));
            if (dist > 0.5) discard; // ç¡¬è¾¹ç¼˜åˆ‡å‰²ï¼Œç¬¦åˆå›¾ç‰‡é‡Œçš„é”åˆ©æ„Ÿ
            gl_FragColor = vec4(vColor, 1.0); 
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);
        // ç™½è‰²é›¾æ°”ï¼Œåˆ¶é€ è¿œå¤„æ¶ˆå¤±çš„æ•ˆæœ
        scene.fog = new THREE.FogExp2(0xffffff, 0.015);

        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        // è§†è§’è°ƒæ•´ï¼šæ”¾ä½ä¸€ç‚¹ï¼Œä¾§çœ‹å±±ä¸˜ï¼Œæ›´æœ‰ Bear 71 çš„æ„Ÿè§‰
        camera.position.set(0, 30, 80);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);

        // --- 3D å…‰æ ‡ç³»ç»Ÿ ---
        const cursorGroup = new THREE.Group();
        scene.add(cursorGroup);

        // å…­è¾¹å½¢ç¯ (åŠ ç²—)
        const hexGeometry = new THREE.RingGeometry(3.0, 4.0, 6); 
        const hexMaterial = new THREE.MeshBasicMaterial({ color: 0x222222, side: THREE.DoubleSide });
        const cursorHex = new THREE.Mesh(hexGeometry, hexMaterial);
        cursorHex.rotation.x = -Math.PI / 2;
        cursorGroup.add(cursorHex);

        // é»‘è‰²å€’ä¸‰è§’ (æŒ‡å‘åœ°é¢)
        const triGeometry = new THREE.ConeGeometry(0.8, 2.0, 3);
        const triMaterial = new THREE.MeshBasicMaterial({ color: 0x000000 });
        const cursorTri = new THREE.Mesh(triGeometry, triMaterial);
        cursorTri.rotation.x = Math.PI; 
        cursorTri.position.y = 6; 
        cursorGroup.add(cursorTri);

        // --- å°„çº¿äº¤äº’ ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        const hitPlane = new THREE.Mesh(new THREE.PlaneGeometry(500, 500), new THREE.MeshBasicMaterial({ visible: false }));
        hitPlane.rotation.x = -Math.PI / 2;
        scene.add(hitPlane);

        // --- åœ°å½¢ç”Ÿæˆ (å…³é”®ä¿®æ”¹ï¼šå¤åˆ»å‚è€ƒå›¾) ---
        const geometry = new THREE.BufferGeometry();
        const positions = [];
        const colors = [];
        const sizes = [];

        // ğŸ¨ å‚è€ƒå›¾å–è‰²
        const colBase = new THREE.Color("#444444"); // æå°çš„åŸºåº•é»‘ç‚¹
        const colWater = new THREE.Color("#66CCFF"); // äº®é’è“
        const colGrassLight = new THREE.Color("#AACC00"); // å«©ç»¿ (å›¾ç‰‡é‡Œçš„é«˜å…‰è‰²)
        const colGrassDark = new THREE.Color("#558800"); // æ·±æ©„æ¦„ç»¿

        const range = 200; 
        const gap = 2.0; // å¯†åº¦ï¼šç‚¹è· 2.0 (æ›´å¯†é›†)

        function getElevation(x, z) {
            // åˆ›é€ èµ·ä¼çš„å±±ä¸˜
            return Math.sin(x * 0.04) * 8 + Math.cos(z * 0.04) * 8 + Math.sin(x*0.1 + z*0.1)*2;
        }

        for (let x = -range; x < range; x += gap) {
            for (let z = -range; z < range; z += gap) {
                
                // 1. è·å–åœ°å½¢é«˜åº¦
                let y = getElevation(x, z);
                
                let pSize = 0.0;
                let pColor = new THREE.Color();

                // 2. é€»è¾‘åˆ†å±‚ (å¤åˆ»å‚è€ƒå›¾é€»è¾‘)
                
                if (y < -4) {
                    // --- ğŸŒŠ æ°´åŸŸ (ä½æ´¼å¤„) ---
                    // å›¾ç‰‡ç‰¹å¾ï¼šæ•´é½æ’åˆ—çš„è“è‰²ç‚¹
                    pSize = 4.0;
                    pColor = colWater;
                    // è®©æ°´é¢å¹³ä¸€ç‚¹
                    y = -4.0 + Math.random() * 0.5;
                } 
                else if (y > 2) {
                    // --- ğŸŒ¿ å±±ä¸˜ (é«˜å¤„) ---
                    // å›¾ç‰‡ç‰¹å¾ï¼šå·¨å¤§çš„ç»¿è‰²åœ†ç‚¹ï¼Œéšé«˜åº¦å˜å¤§
                    
                    // å½’ä¸€åŒ–é«˜åº¦ï¼Œå†³å®šç‚¹çš„å¤§å° (è¶Šé«˜çš„å±±é¡¶ï¼Œç‚¹è¶Šå¤§)
                    const heightFactor = (y - 2) / 10; 
                    pSize = 4.0 + heightFactor * 8.0; // èŒƒå›´ 4.0 -> 12.0
                    
                    // éšæœºåˆ†é…å«©ç»¿å’Œæ·±ç»¿ï¼Œå½¢æˆå±‚æ¬¡
                    if (Math.random() > 0.4) {
                        pColor = colGrassLight; // å«©ç»¿ä¸ºä¸»
                    } else {
                        pColor = colGrassDark;
                        pSize *= 0.8; // æ·±è‰²ç‚¹ç¨å¾®å°ä¸€ç‚¹
                    }
                } 
                else {
                    // --- âš«ï¸ åŸºåº•ç½‘æ ¼ (ä¸­é—´å±‚) ---
                    // å›¾ç‰‡ç‰¹å¾ï¼šæå°çš„é»‘ç‚¹ï¼Œé“ºæ»¡èƒŒæ™¯ï¼Œå‹¾å‹’åœ°å½¢
                    pSize = 0.8; // éå¸¸å°
                    pColor = colBase;
                }

                positions.push(x, y, z);
                colors.push(pColor.r, pColor.g, pColor.b);
                sizes.push(pSize);
            }
        }
        
        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        geometry.setAttribute('customColor', new THREE.Float32BufferAttribute(colors, 3));
        geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));

        const shaderMaterial = new THREE.ShaderMaterial({
            uniforms: { uMouse: { value: new THREE.Vector3(0, 0, 0) } },
            vertexShader: document.getElementById('vertexShader').textContent,
            fragmentShader: document.getElementById('fragmentShader').textContent,
            transparent: true
        });
        const terrain = new THREE.Points(geometry, shaderMaterial);
        scene.add(terrain);

        // --- åŠ¨ç‰©é€»è¾‘ ---
        class Animal {
            constructor(name, type, color, startPos) {
                this.name = name;
                this.info = { desc: "Tracking signal active." };
                
                // åŠ¨ç‰©æœ¬ä½“ (ä¸‰è§’å½¢)
                const geo = new THREE.ConeGeometry(1.5, 3.5, 3);
                const mat = new THREE.MeshBasicMaterial({ color: 0x222222, wireframe: true });
                this.mesh = new THREE.Mesh(geo, mat);
                this.mesh.rotation.x = Math.PI;
                this.mesh.position.copy(startPos);
                
                // æ£•è‰²æ ‡ç­¾ (Bear 71 é£æ ¼)
                this.labelDiv = document.createElement('div');
                this.labelDiv.className = 'bear71-label';
                this.labelDiv.innerText = name;
                this.labelDiv.style.opacity = '0'; // é»˜è®¤éšè—ï¼Œé è¿‘æ˜¾ç¤º
                this.labelDiv.style.transition = 'opacity 0.3s';
                document.body.appendChild(this.labelDiv);

                this.target = startPos.clone();
                this.speed = 0.05;
                scene.add(this.mesh);
                this.pickTarget();
            }
            pickTarget() {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 80;
                this.target.x = Math.cos(angle) * radius;
                this.target.z = Math.sin(angle) * radius;
            }
            update(camera) {
                // ç§»åŠ¨
                const dir = new THREE.Vector3().subVectors(this.target, this.mesh.position);
                if (dir.length() < 1) this.pickTarget();
                dir.normalize();
                this.mesh.position.add(dir.multiplyScalar(this.speed));
                this.mesh.rotation.y += 0.02;
                const y = getElevation(this.mesh.position.x, this.mesh.position.z);
                this.mesh.position.y = y + 6;

                // æ›´æ–° HTML æ ‡ç­¾ä½ç½® (3D è½¬ 2D åæ ‡)
                if (this.labelDiv.style.opacity === '1') {
                    const tempV = this.mesh.position.clone();
                    tempV.y += 4; // æ ‡ç­¾åœ¨å¤´é¡¶
                    tempV.project(camera);
                    const x = (tempV.x * .5 + .5) * window.innerWidth;
                    const y = (tempV.y * -.5 + .5) * window.innerHeight;
                    this.labelDiv.style.left = x + 'px';
                    this.labelDiv.style.top = y + 'px';
                }
            }
        }

        const animals = [
            new Animal("BEAR 107", "Predator", 0x8B4513, new THREE.Vector3(0, 10, 0)),
            new Animal("GOLDEN EAGLE 129", "Flying", 0xCCAA00, new THREE.Vector3(30, 10, 20)),
            new Animal("WOLF 02", "Pack", 0x555555, new THREE.Vector3(-30, 10, -30)),
        ];

        // --- äº¤äº’ ---
        const panel = document.getElementById('data-panel');
        const mouseWorld = new THREE.Vector3();
        let lockedTarget = null;

        document.addEventListener('mousemove', (e) => {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObject(hitPlane);
            if (intersects.length > 0) {
                if (!lockedTarget) mouseWorld.copy(intersects[0].point);
                shaderMaterial.uniforms.uMouse.value.copy(intersects[0].point);
            }
        });

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.3;
        controls.maxPolarAngle = Math.PI / 2 - 0.1;
        controls.minPolarAngle = 0;
        controls.addEventListener('start', () => { controls.autoRotate = false; });

        function animate() {
            requestAnimationFrame(animate);
            
            let currentHover = null;
            animals.forEach(anim => {
                anim.update(camera);
                const dist = new THREE.Vector2(anim.mesh.position.x, anim.mesh.position.z)
                    .distanceTo(new THREE.Vector2(mouseWorld.x, mouseWorld.z));
                if (dist < 8) currentHover = anim;
            });

            if (currentHover) {
                lockedTarget = currentHover;
                // å…‰æ ‡å¸é™„
                const tx = currentHover.mesh.position.x;
                const tz = currentHover.mesh.position.z;
                const ty = getElevation(tx, tz);
                
                cursorGroup.position.lerp(new THREE.Vector3(tx, ty, tz), 0.1);
                cursorGroup.scale.lerp(new THREE.Vector3(2, 2, 2), 0.1);
                hexMaterial.color.set(0x8B4513); // å˜æ£•è‰²

                // æ˜¾ç¤º UI å’Œæ ‡ç­¾
                document.getElementById('panel-name').innerText = currentHover.name;
                document.getElementById('bar-tox').style.width = "80%";
                document.getElementById('bar-adp').style.width = "60%";
                panel.style.display = 'block';
                currentHover.labelDiv.style.opacity = '1';

            } else {
                lockedTarget = null;
                // å…‰æ ‡è·Ÿéšé¼ æ ‡
                const ty = getElevation(mouseWorld.x, mouseWorld.z);
                cursorGroup.position.lerp(new THREE.Vector3(mouseWorld.x, ty, mouseWorld.z), 0.2);
                cursorGroup.scale.lerp(new THREE.Vector3(1, 1, 1), 0.1);
                hexMaterial.color.set(0x222222);

                // éšè— UI å’Œæ ‡ç­¾
                panel.style.display = 'none';
                animals.forEach(a => a.labelDiv.style.opacity = '0');
            }

            cursorHex.rotation.z += 0.01;
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
